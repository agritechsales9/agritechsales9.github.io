<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>AGRI_TECH SALES</title>
  <link href="style.css" rel="stylesheet" type="text/css" />
  <link rel="icon" type="image/x-icon" href="Preview(1).png"/>
  <link rel="stylesheet" href="kk.css"> 
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body>
  <!---page one-->
  <div class="cards" id="home">
    <div class="topp">
      <h3>AGRI_TECH</h3>
      <input type="text" id="search" placeholder="Search...">
      <button class="btnLogin-popup" id="button_intiate">Log in</button>
    </div>
    

    <!---content presentation-->
    <div>
      <div id="image"></div>
      <div id="price"></div>
      <div id="name"></div>
      <div id="desc"></div>
    </div>
    <!---CONTENT HOLDER-->
    <div id="holder">
    </div>
  </div>
  <!--page two-->
  <div id="alert-box" class="alert-box"></div>
  <div class="cards" id="sell">
    <h3>Hello <span id="name-holder"></span></h3>
    <div>
      <div id="backimg">
          <input type="file" id="imge-files" accept="image/jpeg, image/png, image/jpg, image/jfif"/>
          <span>Click to add</span>
      </div>
      <input type="text" id="product-name" placeholder="Product Name">
      <input type="text" id="product-price" placeholder="Product Price">
      <textarea cols="30" rows="10" id="product-description" placeholder="Product description"></textarea>
      <button id="poster">POST</button>
    </div>
          <div>
              <div id="prog-bar"></div>
          </div>
  </div>
  <!--page three-->
  <div class="cards" id="chat">
    <div>
      
      <section id="two">
         <h4 id="chat-title"></h4>
        <div id="chat-holder"></div>
            <div>
              <input type="text" id="chat-messages" placeholder="Message...">
              <button type="button" id="chat-send">
                <span class="material-symbols-outlined">
                send
                </span>
              </button>
            </div>
      </section>

      
      
    
    </div>
  </div>
 
  <nav>
    <button id="to-home">
      <p><span class="material-symbols-outlined">home</span></p>
      
    </button>
    <button id="to-sell">
      <p><span class="material-symbols-outlined">add_circle</span></p>
      
    </button>
    <button id="to-chat">
      <p><span class="material-symbols-outlined">chat</span></p>
      
    </button>
  </nav>
  <!--the sign in handlers-->
  <div class="wrapper">
      <span class="icon-close">
          <ion-icon name="close">âœ–</ion-icon>
      </span>
      <div class="form-box login">
          <h2>Login</h2>
          <div>
              <div class="input-box">
                  <span class="icon"><ion-icon name="mail"></ion-icon></span>
                  <input type="text" id="login_name" required>
                  <label>User name</label>
              </div>
              <div class="input-box">
                  <span class="icon"><ion-icon name="lock-closed"></ion-icon></ion-icon></span>
                  <input type="password" id="log_passcode" required>
                  <label>Password</label>
              </div>
              <div class="remember-forgot">
                  <label><input type="checkbox">
                  Remember me</label>
                  <a href="#">Forgot Password?</a>
              </div>
              <button type="button" id="login_btn" class="btn">Login
              </button>
              <div class="login-register">
                  <p>Don't have an account?<a href="#"
                       class="register-link">Sign-up</a></p>
              </div>
          </div>
      </div>

      <div class="form-box register">
          <h2>Sign-up</h2>
          <section id="form2">
              <div class="input-box">
                  <span class="icon"><ion-icon name="person"></ion-icon>
                  </span>
                  <input type="text" id="username" required>
                  <label>Username</label>
              </div>
              <div class="input-box">
                  <span class="icon"><ion-icon name="mail"></ion-icon></span>
                  <input type="email" id="email" required>
                  <label>Email</label>
              </div>
              <div class="input-box">
                  <span class="icon"><ion-icon name="lock-closed"></ion-icon></ion-icon></span>
                  <input type="password" id="passcode" required>
                  <label>Password</label>
              </div>
              <button type="button" class="btn" id="sign-btn">Sign-up
              </button>
              <div class="login-register">
                  <p>Already have an account?<a href="#"
                       class="login-link">Login</a>
                      </p>
              </div>
          </section>
      </div>
  </div>
  <script src="first.js"></script>
  <script type="module">
    //universal
    var home = document.getElementById("home");
    var sell = document.getElementById("sell");
    var chat = document.getElementById("chat");

    var homeButton = document.getElementById("to-home");
    var sellButton = document.getElementById("to-sell");
    var chatButton = document.getElementById("to-chat");

    homeButton.addEventListener("click", function(){
      home.style.display = "block";
      sell.style.display = "none";
      chat.style.display = "none";
    });
    sellButton.addEventListener("click", function(){
      home.style.display = "none";
      sell.style.display = "block";
      chat.style.display = "none";
    });
    chatButton.addEventListener("click", function(){
      home.style.display = "none";
      sell.style.display = "none";
      chat.style.display = "block";
    });
   
    var alertBox = document.getElementById("alert-box");
    //page one functions
    const holder = document.getElementById("holder");
    var searchInput = document.getElementById("search");
    
    searchInput.addEventListener("input", (e) => {
      var word = new RegExp(e.target.value, "gi");
      holder.querySelectorAll("p").forEach((paragraph) => {
        if (paragraph.textContent.match(word)) {
          paragraph.style.display = "block";
        } else {
          paragraph.style.display = "none";
        }
      });
    });
    var imageHolder = document.getElementById("image");
    var priceHolder = document.getElementById("price");
    var nameHolder = document.getElementById("name");
    var descHolder = document.getElementById("desc");
holder.querySelectorAll("p").forEach((paragraph) => {
  paragraph.addEventListener("click", (e) => {
    var content = e.target;
    var image = content.querySelector(".image");
    var name = content.querySelector(".product-name");
    var price = content.querySelector(".product-price");
    var desc = content.querySelector(".description");
    var href = image.getAttribute("href");
    imageHolder.innerHTML = `<img src="${href}"/>`;
    priceHolder.innerHTML = `<p>${price.innerHTML}</p>`;
    nameHolder.innerHTML = `<p>${name.innerHTML}</p>`;
    descHolder.innerHTML = `<p>${desc.innerHTML}</p>`;
    
    
  })
});
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, remove, orderByChild, query, update } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7fCNZe8l-fGhhKsMF0JVcymh8uCv1zyI",
      authDomain: "lavender-app-eeeb0.firebaseapp.com",
      databaseURL: "https://lavender-app-eeeb0-default-rtdb.firebaseio.com",
      projectId: "lavender-app-eeeb0",
      storageBucket: "lavender-app-eeeb0.appspot.com",
      messagingSenderId: "666797584961",
      appId: "1:666797584961:web:8d9576c372d72fe0938cc0",
      measurementId: "G-ECZ1J6F0KK"
    };


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const productsQuery = query(ref(db, 'products/'), orderByChild('timestamp'));

    onValue(productsQuery, (snapshot) => {
      holder.innerHTML = "";
      const data = snapshot.val();

      Object.keys(data).sort((a, b) => data[a].timestamp - data[b].timestamp).forEach((key) => {
        const productData = data[key];
        const product = document.createElement("div");
        const productName = document.createElement("div");
        const productPrice = document.createElement("div");
        const description = document.createElement("div");
        const emailink = document.createElement("a");

        const imageURL = productData.imageUrl;
        const imagespecs = productData.imageSpecify;

        const image = document.createElement("img");
        image.className = "image";
        product.appendChild(image);
        var imageRef = sRef(storage, "images/" + imageURL);

        getDownloadURL(imageRef)
          .then((downloadURL) => {
            image.setAttribute("src", downloadURL);
          })
          .catch((error) => {
            console.error("Error fetching image:", error);
            image.setAttribute("alt", "Image not available"); 
          });
        emailink.innerHTML = "Email";
        emailink.setAttribute("href", "mailto:" + productData.emailink);
        productName.innerHTML = productData.productName;
        productPrice.innerHTML = productData.productPrice;
        description.innerHTML = productData.productDescription;

        productName.className = "product-name";
        productPrice.className = "product-price";
        description.className = "description";

        product.appendChild(productName);
        product.appendChild(productPrice);
        product.appendChild(emailink);
        product.appendChild(description);

        product.className = "product";
        holder.appendChild(product);
      });
    });

    //page two functions...sells
    const urName = document.getElementById("name-holder");

    const imageFile = document.getElementById("imge-files");
    const productNamer = document.getElementById("product-name");
    const productPricer = document.getElementById("product-price");
    const productDescribe = document.getElementById("product-description");
    const postingButton = document.getElementById("poster");
    const progressBar = document.getElementById("prog-bar");
    const backgroundHolder = document.getElementById("backimg");
    let imageItem;
    let imageName;
    imageFile.addEventListener("change", function(e) {
        imageItem = e.target.files[0];
        imageName = imageItem.name;
        var reader = new FileReader();
      reader.onload = function(e) {
        backgroundHolder.style.backgroundImage = `url(${e.target.result})`;
      };
      reader.readAsDataURL(imageItem);
      
    });

    postingButton.addEventListener("click", function() {
      if (!productNamer.value || !productPricer.value || !productDescribe.value || !imageName) {
          alert("All fields are required!");
          return;
      }

      if (imageName) {
        const storageRef = sRef(storage, "images/" + imageName);
        const uploadTask = uploadBytesResumable(storageRef, imageItem);

        uploadTask.on("state_changed", 
          (snapshot) => {
            const progress = Math.floor((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            progressBar.style.width = progress + "%";
          }, 
          (error) => {
            console.error("Upload failed:", error);
          }, 
          () => {
            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
              const timestamp = new Date().getTime();
              const productRefer = push(ref(db, "products/"));
              const Sender = urName.getAttribute("class");
              set(productRefer, {
                emailink: Sender,
                user: urName.innerHTML,
                productName: productNamer.value,
                productPrice: productPricer.value,
                productDescription: productDescribe.value,
                imageUrl: imageName,
                imageSpecify: imageItem,
                timestamp: timestamp
              }).then(() => {
                productNamer.value = "";
                productPricer.value = "";
                productDescribe.value = "";
                progressBar.style.width = "0%";
                imageFile.value = "";
                backgroundHolder.style.backgroundImage = "none";
              }).catch((error) => {
                console.error("Error saving product:", error);
              });
            });
          }
        );
      }
    });

    //page three...chat functions
 
    //login... submission
    const initiateButton = document.getElementById("button_intiate");
    
    var loginName = document.getElementById("login_name");
    var loginPass = document.getElementById("log_passcode");
    var loginButton = document.getElementById("login_btn");
    loginButton.addEventListener("click", async (e) => {
      try {
        const snapshot = await get(ref(db, "accounts/"));
        const data = snapshot.val();
        if (data && data[loginName.value]) {
          const userData = data[loginName.value];
          if (userData.passcode === loginPass.value) {
            initiateButton.innerHTML = `Hello ${userData.username}`;
            urName.innerHTML = userData.username;
            urName.className = userData.email;
            alert("Login successful");
            wrapper.classList.remove('active-popup');
            loginName.value = "";
            loginPass.value = "";
          } else {
            showAlert("Incorrect password");
          }
        } else {
          showAlert("Account not found");
        }
      } catch (error) {
        console.error(error);
        showAlert("An error occurred during login");
      }
    });

    function showAlert(message) {
      alertBox.innerHTML = message;
      alertBox.style.visibility = "visible";
      setTimeout(function() {
        alertBox.style.visibility = "hidden";
      }, 2000);
    }

    //sign in ... submission
    const signInButton = document.getElementById("sign-btn");
      var userName = document.getElementById("username");
      var email = document.getElementById("email");
      var passcode = document.getElementById("passcode");
      const wrapper = document.querySelector('.wrapper');
    signInButton.addEventListener("click", async function(e) {
      if (userName.value == "" || email.value == "" || passcode.value == "") {
        alertBox.innerHTML = "Please fill all fields...";
        alertBox.style.visibility = "visible";
        setTimeout(function() {
          alertBox.style.visibility = "hidden";
        }, 2000);
      } else {
        var accountsRef = ref(db, "accounts/" + userName.value);
        try {
          await set(accountsRef, {
            username: userName.value,
            email: email.value,
            passcode: passcode.value,
            timestamp: new Date().getTime()
          });
          wrapper.classList.remove('active-popup');
          initiateButton.innerHTML = `Hello ${userName.value}`;
          urName.innerHTML = userName.value;
          urName.className = email.value;
          email.value = "";
          passcode.value = "";
        } catch (error) {
          console.error(error);
          alertBox.innerHTML = "An error occurred while setting data.";
          alertBox.style.visibility = "visible";
          setTimeout(function() {
            alertBox.style.visibility = "hidden";
          }, 2000);
        }
      }
    });
    //chats...
    var chatHolder = document.getElementById("chat-holder");
    var chatMessages = document.getElementById("chat-messages");
    var chatSend = document.getElementById("chat-send");

    chatSend.addEventListener("click", function() {
      if (chatMessages.value.trim() != "") {
        const timestamp = new Date().getTime(); 
        const newMessageRef = push(ref(db, 'chat/'));

        set(newMessageRef, {
          user: urName.innerHTML,
          message: chatMessages.value,
          timestamp: timestamp
        }).then(() => {
          chatMessages.value = ""; 
        });
      }
    });

    const messagesQuery = query(ref(db, 'chat/'), orderByChild('timestamp'));
    const stylesTo = {
      background: 'lightblue',
      margin: '5px',
      borderRadius: '30px',
      borderBottomLeftRadius:'0'
      
    };
    const stylesFro = {
      background: 'lightgreen',
      margin: '5px',
      borderRadius: '30px',
      borderBottomRightRadius:'0'
    };

    onValue(messagesQuery, (snapshot) => {
      const data = snapshot.val();
      chatHolder.innerHTML = "";

      if (data) {
        Object.keys(data).sort((a, b) => data[a].timestamp - data[b].timestamp).forEach((key) => {
          if(urName.innerHTML == `${data[key].user}`){
             var messageContainer = document.createElement("div");
            var messageSender = document.createElement("p");
                  messageContainer.className = "message-container";
            for(let key in stylesTo){
              messageContainer.style[key] = stylesTo[key];
            }
            messageSender.innerHTML = `${data[key].user}:`;

                  var messageToAdd = document.createElement("p");
                 
                  messageToAdd.className = "message";
                  messageToAdd.innerHTML = `${data[key].message}`;
messageContainer.appendChild(messageSender);
messageContainer.appendChild(messageToAdd);
chatHolder.appendChild(messageContainer);
          }else{
            var messageContainer = document.createElement("div");
                  messageContainer.className = "message-container";
             var messageSender = document.createElement("p");
            messageSender.innerHTML = `${data[key].user}:`;
            for(let key in stylesFro){
              messageContainer.style[key] = stylesFro[key];
            }

                  var messageToAdd = document.createElement("p");
                  messageToAdd.className = "message";
                  messageToAdd.innerHTML = `${data[key].message}`;
messageContainer.appendChild(messageSender);
messageContainer.appendChild(messageToAdd);
                  chatHolder.appendChild(messageContainer);
          }
        });
      }
    });

  </script>
</body>

</html>
